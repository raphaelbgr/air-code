FROM node:22-bookworm-slim AS builder

# Install pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /app

# Copy workspace files
COPY pnpm-workspace.yaml package.json pnpm-lock.yaml tsconfig.base.json ./
COPY packages/shared/package.json packages/shared/tsconfig.json ./packages/shared/
COPY packages/was/package.json packages/was/tsconfig.json ./packages/was/
COPY packages/web/package.json packages/web/tsconfig.json packages/web/vite.config.ts ./packages/web/

# Install dependencies
RUN pnpm install --frozen-lockfile

# Copy source
COPY packages/shared/src ./packages/shared/src
COPY packages/was/src ./packages/was/src
COPY packages/web/src ./packages/web/src
COPY packages/web/index.html ./packages/web/

# Build
RUN pnpm --filter @claude-air/shared build \
 && pnpm --filter @claude-air/was build \
 && pnpm --filter @claude-air/web build

# ── Production image ──
FROM node:22-bookworm-slim

RUN corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /app

COPY --from=builder /app/pnpm-workspace.yaml /app/package.json /app/pnpm-lock.yaml ./
COPY --from=builder /app/packages/shared/package.json ./packages/shared/
COPY --from=builder /app/packages/shared/dist ./packages/shared/dist
COPY --from=builder /app/packages/was/package.json ./packages/was/
COPY --from=builder /app/packages/was/dist ./packages/was/dist
COPY --from=builder /app/packages/web/dist ./packages/web/dist

# Install production dependencies only
RUN pnpm install --frozen-lockfile --prod

# Create data directory
RUN mkdir -p /app/data

EXPOSE 7333

HEALTHCHECK --interval=30s --timeout=5s --start-period=10s \
  CMD curl -f http://localhost:7333/api/health || exit 1

CMD ["node", "packages/was/dist/index.js"]
