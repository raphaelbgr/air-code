FROM node:22-bookworm-slim

# Install tmux
RUN apt-get update && apt-get install -y tmux && rm -rf /var/lib/apt/lists/*

# Install pnpm
RUN corepack enable && corepack prepare pnpm@latest --activate

WORKDIR /app

# Copy workspace files
COPY pnpm-workspace.yaml package.json pnpm-lock.yaml tsconfig.base.json ./
COPY packages/shared/package.json packages/shared/tsconfig.json ./packages/shared/
COPY packages/sms/package.json packages/sms/tsconfig.json ./packages/sms/

# Install dependencies
RUN pnpm install --frozen-lockfile

# Copy source
COPY packages/shared/src ./packages/shared/src
COPY packages/sms/src ./packages/sms/src

# Build
RUN pnpm --filter @claude-air/shared build && pnpm --filter @claude-air/sms build

# Create data directory
RUN mkdir -p /app/data

EXPOSE 7331

HEALTHCHECK --interval=30s --timeout=5s --start-period=10s \
  CMD curl -f http://localhost:7331/api/health || exit 1

CMD ["node", "packages/sms/dist/index.js"]
